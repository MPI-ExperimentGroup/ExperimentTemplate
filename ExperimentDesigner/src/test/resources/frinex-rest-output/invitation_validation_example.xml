<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<experiment xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="frinex.xsd" userIdGetParam="invitation_id" appNameDisplay="invitation_validation_example" appNameInternal="invitation_validation_example" backgroundColour="#FFFFFF" complementColour0="#EAC3A3" complementColour1="#9D7B5E" complementColour2="#C69E7C" complementColour3="#FFEDDE" complementColour4="#FFFDFB" defaultScale="1.0" isScalable="true" preserveLastState="false" primaryColour0="#628D8D" primaryColour1="#385E5E" primaryColour2="#4A7777" primaryColour3="#96ADAD" primaryColour4="#D5D8D8" rotatable="true" showMenuBar="true" textFontSize="17">
    <administration>
        <!--// todo: there probably needs to be a tag: set userId from MetadataFieldValue, or directly from an input field, so that iOS app users can use a consistant userId over app updates, from there the user can be validated and the known metadata can be repopulated fromthe validatoin request--> 
        <!--<validation matchingRegex="invitation_id|session_id|session_copepods|session_copepod|session_next_copepod|validation_error" enabledRegex="validated_invitation_id|validation_error"-->
        <!--<authentication tokenField="userTokenField" errorMessage="The userId and the hashed contents of the token field must be sent in the HTTP authentication header,before any data can be sent to the admin server"/>-->
        <validation fieldName="userId" returnName="validated_invitation_id" errorMessage="Validated user not found." errorField="validation_error" allowValidationOnMissing="true"/>
        <validation postName="invitation_id" fieldName="userId" errorMessage="The invitation_id does not match the current user ID. (Please switch the current user ID to the invitation ID)" errorField="validation_error" allowValidationOnMissing="true"/>
        <!--matchExistingValue="true"--> 
        <!---->
        <!--validationRegex="" matchingRegex=""--> 
        <validation postName="session_id" fieldName="session_id" validationRegex="[0-6]" errorMessage="session id not found or invalid[0-6]." errorField="validation_error"/>
        <validation postName="session_copepods" fieldName="session_copepods" returnName="session_copepods" errorMessage="session_copepods not recognised." errorField="session_validation_error"/>
        <validation postName="session_copepod" fieldName="session_copepod" returnName="session_copepod" errorMessage="session_copepod does not match the known value." errorField="session_validation_error"/>
        <validation postName="session_next_copepod" fieldName="session_next_copepod" errorMessage="session_next_copepod does not match the known value." errorField="session_validation_error"/>
        <validation fieldName="copepod_done" validationRegex="|no" returnName="copepod_done" errorMessage="This session has already been completed and cannot be restarted." errorField="session_validation_error"/>
        <!--note that we are not currenty trying to authenticate here, we are only testing values and optinally returning them in a new variable name and or a message variable-->
    </administration>
    <scss/>
    <metadata>
        <field controlledMessage="Voer minimaal drie letters." controlledRegex=".'{'3,'}'" postName="workerId" preventServerDuplicates="false" registrationField="Proefpersoon ID"/>
        <!-- The attribute in the Experiment element userIdGetParam="invitation_id" allows the internal user id to be set via the get parameter and this metadata field -->
        <field controlledMessage="Please enter your invitation ID." controlledRegex=".'{'3,'}'" postName="invitation_id" preventServerDuplicates="false" registrationField="Invitation ID"/>
        <field controlledMessage="." controlledRegex=".'{'3,'}'" postName="validated_invitation_id" preventServerDuplicates="false" registrationField="Validated Invitation ID"/>
        <field controlledMessage="." controlledRegex=".'{'3,'}'" postName="validation_error" preventServerDuplicates="false" registrationField="Validation Error"/>
        <field controlledMessage="." controlledRegex=".'{'3,'}'" postName="session_validation_error" preventServerDuplicates="false" registrationField="Session Validation Error"/>
        <field controlledMessage="Please enter your session number [0-9]." controlledRegex="[0-9]" postName="session_id" preventServerDuplicates="false" registrationField="session id"/>
        <field controlledMessage="." controlledRegex="|no|yes" postName="copepod_done" preventServerDuplicates="false" registrationField="session done"/>
        <field controlledMessage="." controlledRegex=".'{'3,'}'" postName="session_copepods" preventServerDuplicates="false" registrationField="session copepods"/>
        <field controlledMessage="." controlledRegex="|Copepod|Antrisocopia prehensilis|Karllangia pulchra|Misophrioida|Monstrilloida|Mormonillidae|Platycopiidae|Poecilostomatoida|Siphonostomatoida|Speleophria bivexilla|Speleophria scottodicarloi|Speleophriidae|Tigriopus brevicornis" postName="session_copepod" preventServerDuplicates="false" registrationField="session copepod"/>
        <field controlledMessage="." controlledRegex=".'{'3,'}'" postName="session_next_copepod" preventServerDuplicates="false" registrationField="session_next_copepod"/>
        <field controlledMessage="." controlledRegex=".'{'3,'}'" postName="invitation_code" preventServerDuplicates="false" registrationField="invitation code"/>
    </metadata>
    <presenter menuLabel="Menu" type="menu" self="Menu" title="Overview">
        <htmlText featureText="This example demostrates three ways of causing a participant to have the same identifier for an experiment over separate days or via separate devices or browsers. Normally a participant will be given a new identifer when they change to a different browser or device or update a amobile app. This is because the system has no way to know who the participant is after such a change. The methods in this example can be used to overcome this by providing a consistant identifier to each particpant."/>
        <addPadding/>
        <targetButton featureText="Invitation URL Example" target="InvitationUrlExample"/>
        <addPadding/>
        <targetButton featureText="Invitation Text Example" target="InvitationTextExample"/>
        <addPadding/>
        <targetButton featureText="Invitation Validation Example" target="EnterInvitationMetadata"/>
    </presenter>
    <presenter back="Menu" menuLabel="InvitationUrlExample" type="stimulus" self="InvitationUrlExample" title="Invitation URL Example">
        <htmlText featureText="The first method requires providing your participant with a URL containing their specific identfier and populating the attribute userIdGetParam=&quot;invitation_id&quot; in the experiment configuration."/>
        <addPadding/>
        <htmlText featureText="For example a URL GET parameter could look like (&lt;a href=&quot;?invitation_id=yourcode&quot;&gt;?invitation_id=[yourcode]&lt;/a&gt;), which they can enter into the browser."/>
        <addPadding/>
        <htmlText featureText="This method only sends collected data to the server. Which means the participant will &lt;b&gt;start from scratch&lt;/b&gt; if they do change to a different machine or browser or if they clear the browser data storage. However the participant will have the same identifier each time, providing they keep uisng that complete URL."/>
        <addPadding/>
        <htmlText featureText="Please note that this method cannot be used in a mobile app nor a desktop app, because the participant cannot enter the URL."/>
        <addPadding/>
        <hasGetParameter parameterName="invitation_id">
            <conditionTrue>
                <htmlTokenText featureText="
                The participants invitation identifier has been received and is:
                &lt;b&gt;&lt;metadataField_invitation_id&gt;&lt;/b&gt;&lt;br/&gt;&lt;br/&gt;
                The collected results should now be available via the provided participant id."/>
                <addPadding/>
                <htmlText featureText="In the flowing examples you should remove the invitation_id from the URL. Which can be done by clicking this link: (&lt;a href=&quot;?&quot;&gt;link&lt;/a&gt;)."/>
            </conditionTrue>
            <conditionFalse>
                <htmlText featureText="The invitation identifier has not been found. Try clicking the link above."/>
            </conditionFalse>
        </hasGetParameter>
    </presenter>
    <presenter back="Menu" menuLabel="InvitationTextExample" type="metadata" self="InvitationTextExample" title="Invitation Text Example">
        <htmlTokenText featureText="In the case of Mobile and Desktop apps it is not possible for the participant to enter a URL with their invition ID. So in this example they can enter the ID into a metadata field and then via the switchUserIdButton tag they can be switched to that user."/>
        <addPadding/>
        <htmlText featureText="This method only sends collected data to the server. Which means the participant will &lt;b&gt;start from scratch&lt;/b&gt; if they do change to a different machine or browser or if they clear the browser data storage. However the participant will have the same identifier, providing they enter the correct invitation ID each time."/>
        <addPadding/>
        <htmlText featureText="This example requires the invitation ID to follow the following format of three letters followed by 9 numbers: abc123456789."/>
        <addPadding/>
        <htmlTokenText featureText="Current User ID: &lt;userId&gt;"/> 
        <addPadding/>
        <metadataField fieldName="invitation_id"/>
        <addPadding/>
        <saveMetadataButton featureText="Save Invitation ID" sendData="true" networkErrorMessage="Geen verbinding met de server. Controleer alstublieft uw internetverbinding en probeer het opnieuw.">
            <onError>
                <htmlText featureText="Save metadata failed"/>
            </onError>
            <onSuccess>
                <hasMetadataValue fieldName="invitation_id" matchingRegex="...*">
                    <conditionTrue>
                        <addPadding/>
                        <htmlTokenText featureText="Current User ID: &lt;userId&gt;"/> 
                        <addPadding/>
                        <htmlTokenText featureText="
                Your invitation ID has been saved and is:
                &lt;metadataField_invitation_id&gt;&lt;br/&gt;
                "/>
                        <addPadding/>
                        <switchUserIdButton featureText="Switch current user ID to the invitation ID" fieldName="invitation_id" validationRegex="[a-z][a-z][a-z][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]" styleName="styleName">
                            <onError>
                                <htmlText featureText="onError"/>
                                <htmlText featureText="Please make sure your invitation ID matches the validationRegex [a-z][a-z][a-z][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]"/>
                                <addPadding/>
                                <htmlTokenText featureText="User ID unchanged: &lt;userId&gt;"/> 
                            </onError>
                            <onSuccess>
                                <htmlText featureText="onSuccess"/>
                                <addPadding/>
                                <htmlTokenText featureText="Current User ID: &lt;userId&gt;"/> 
                            </onSuccess>
                        </switchUserIdButton>
                    </conditionTrue>
                    <conditionFalse>
                        <addPadding/>
                        <htmlText featureText="Your invitation code has not been found or is less that three characters long.&lt;br/&gt;
                Please provide this code as a URL GET parameter (&lt;a href=&quot;?invitation_id=yourcode&quot;&gt;?invitation_id=[yourcode]&lt;/a&gt;) and reload this page."/>
                    </conditionFalse>
                </hasMetadataValue>
            </onSuccess>
        </saveMetadataButton>
    </presenter>
    <!--    <presenter back="Informatie" menuLabel="Gegevens" next="Metadata_Jump_Test" type="metadata" self="Gegevens" title="Gegevens">
        <metadataField fieldName="workerId"/>
        <metadataField fieldName="age"/>
        <metadataField fieldName="gender"/>
        <metadataField fieldName="education"/>
        <metadataFieldVisibilityDependant fieldName="educationOther" linkedFieldName="education" visibleRegex="anders" enabledRegex=".*"/>
        <metadataFieldConnection fieldName="connection" linkedFieldName="workerId" oneToMany="false"/>
        <metadataFieldConnection fieldName="connections" linkedFieldName="workerId" oneToMany="true"/>
        <metadataField fieldName="dateOfBirth"/>
        <metadataFieldDateTriggered fieldName="ageGroup" linkedFieldName="dateOfBirth" daysThresholds="50 100 200 400 500 600 800 1000" visibleRegex=".*" enabledRegex=".*"/>
        <addPadding/>
        <htmlText featureText="When a dateOfBirth is entered the Instapset dropdown will jump to the age group specified in the daysThresholds attribute. This dropdown can then be editied as required."/>
        <htmlText featureText="The restulting value of Instapset can then be used in the following presenter to jump to the relevant section of the experiment."/>
        <addPadding/>
        <htmlText featureText="When Opleidingsniveau is equal to anders the extra field educationOther will be shown."/>
        <addPadding/>
        <saveMetadataButton featureText="Volgende" sendData="true" networkErrorMessage="Geen verbinding met de server. Controleer alstublieft uw internetverbinding en probeer het opnieuw.">
            <onError/>
            <onSuccess>
                <gotoNextPresenter/>
            </onSuccess>
        </saveMetadataButton>
    </presenter>-->
    <presenter back="Menu" menuLabel="Enter Invitation Metadata" type="metadata" self="EnterInvitationMetadata" title="Enter Invitation Metadata">
        <htmlTokenText featureText="In this example the participant must enter the invitation ID into a metadata field and then save the metadata. In the following presenter via the switchUserIdButton tag they can be switched to that user. Only after that point can the participant ID and the invitation ID be validated by the server."/>
        <addPadding/>
        <htmlText featureText="Please keep in mind that validation is not authentication. Validation in this case is just keeping track of the invitation ID and preserving some of the previous state via metadata field values."/>
        <addPadding/>
        <htmlText featureText="During the validation process the most recent validatad metadata is checked. In this case the copepod_done field is checked and the validation will fail unless it is blank or 'no'. However because allowValidationOnMissing is set to true in the configuration file, any participant ID will be allowed if there are no existing records for it."/>
        <addPadding/>
        <htmlText featureText="This method is very different from the preceding examples because it checks and gets the most recent validated metadata values from the server. However this depends on the participant entering the correct invitation ID each time."/>
        <addPadding/>
        <htmlText featureText="Please note that any metadata that is saved before validation will probably be overwritten by they last validated metadata on the server."/>
        <addPadding/>
        <htmlText featureText="In this example the metadata field validated_invitation_id is used to indicate the validated state. Please see the configuration file for details of its use. Also this field should not be user editable."/>
        <addPadding/>
        <htmlText featureText="It is also possible to create participants in the administration system and set allowValidationOnMissing to false. Which would allow only predefined participants to validate. However this use case is not covered in this example experiment."/>
        <addPadding/>
        <htmlText featureText="This example requires the invitation ID to follow the following format of three letters followed by 9 numbers: abc123456789."/>
        <addPadding/>        
        <htmlTokenText featureText="Current User ID: &lt;userId&gt;"/> 
        <addPadding/>
        <htmlTokenText featureText="invitation_id: &lt;metadataField_invitation_id&gt;"/> 
        <addPadding/>
        <htmlTokenText featureText="validated_invitation_id: &lt;metadataField_validated_invitation_id&gt;"/> 
        <addPadding/>
        <hasMetadataValue fieldName="validated_invitation_id" matchingRegex="...*">
            <conditionTrue>
                <htmlText featureText="A &quot;validated_invitation_id&quot; has been found and it must match the provided &quot;invitation_id&quot;."/>
                <hasMetadataValue fieldName="invitation_id" matchingRegex="&lt;metadataField_validated_invitation_id&gt;">
                    <conditionTrue>
                        <htmlText featureText="The &quot;validated_invitation_id&quot; does match &quot;invitation_id&quot; and you can continue."/>
                        <!--<targetButton featureText="volgende [ spatiebalk ]" hotKey="SPACE" target="InvitationCodeExampleStimuliScreen"/>-->
                    </conditionTrue>
                    <conditionFalse>
                        <htmlText featureText="The &quot;validated_invitation_id&quot; does NOT match &quot;invitation_id&quot;."/>
                        <!--<targetButton featureText="volgende [ spatiebalk ]" hotKey="SPACE" target="InvitationCodeExampleInvalid"/>-->
                        <!--<eraseUsersDataButton featureText="Erase old data" target="InvitationSessionStepsExample"/>-->
                    </conditionFalse>
                </hasMetadataValue>
            </conditionTrue>
            <conditionFalse>
                <htmlText featureText="The validated_invitation_id will be set after the validation process."/>
            </conditionFalse>
        </hasMetadataValue>
        <addPadding/>
        <metadataField fieldName="invitation_id"/>
        <metadataField fieldName="session_id"/>
        <metadataField fieldName="session_copepod"/>
        <metadataField fieldName="copepod_done"/>
        <htmlText featureText="This example has some additional metadata fields, which do not directly interact with the validation process: &quot;session_copepods&quot;, &quot;session_copepod&quot; and &quot;session_next_copepod&quot;."/>
        <!--<htmlText featureText="Assuming the list contains session_copepod we act as if the name of this experiment is session_copepod and using setMetadataValue get the next item which is peabodyas."/>-->
        <htmlText featureText="In some experiments the value in &quot;session_next_copepod&quot; would later be used to redirect the user to that next experiment after the current one is complete."/>
        <setMetadataValue fieldName="session_copepods" dataLogFormat="Copepod_Antrisocopia prehensilis_Karllangia pulchra_Misophrioida_Monstrilloida_Mormonillidae_Platycopiidae_Poecilostomatoida_Siphonostomatoida_Speleophria bivexilla_Speleophria scottodicarloi_Speleophriidae_Tigriopus brevicornis"/>
        <setMetadataValue fieldName="session_next_copepod" replacementRegex="&lt;metadataField_session_copepod&gt;_([^_]*)[_$]" dataLogFormat="&lt;metadataField_session_copepods&gt;"/>
        <!--// if the response invitation_id does not exist then transmit-->
        <saveMetadataButton featureText="Save Metadata" sendData="true" networkErrorMessage="Geen verbinding met de server. Controleer alstublieft uw internetverbinding en probeer het opnieuw.">
            <onError>
                <htmlText featureText="Save metadata failed"/>
            </onError>
            <onSuccess>
                <gotoPresenter target="InvitationValidationExample"/>
            </onSuccess>
        </saveMetadataButton>
        <!--<targetButton featureText="Send Invitation Request" target="InvitationValidationExample"/>-->
    </presenter>
    <presenter back="Menu" menuLabel="Invitation Validation Example" type="transmission" self="InvitationValidationExample" title="Invitation Validation Example">
        <htmlTokenText featureText="Current User ID: &lt;userId&gt;"/> 
        <htmlTokenText featureText="&quot;invitation_id&quot;: &lt;metadataField_invitation_id&gt;"/>
        <htmlTokenText featureText="&quot;session_id&quot;: &lt;metadataField_session_id&gt;"/>
        <htmlTokenText featureText="&quot;session_copepod&quot;: &lt;metadataField_session_copepod&gt;"/>
        <htmlTokenText featureText="&quot;copepod_done&quot;: &lt;metadataField_copepod_done&gt;"/>
        <htmlTokenText featureText="&quot;session_next_copepod&quot;: &lt;metadataField_session_next_copepod&gt;"/>
        <addPadding/>
        <switchUserIdButton featureText="Switch current user ID to the invitation ID" fieldName="invitation_id" validationRegex="[a-z][a-z][a-z][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]" styleName="styleName">
            <onError>
                <htmlText featureText="onError"/>
                <htmlText featureText="Please make sure your invitation ID matches the validationRegex [a-z][a-z][a-z][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]"/>
                <addPadding/>
                <htmlTokenText featureText="User ID unchanged: &lt;userId&gt;"/> 
            </onError>
            <onSuccess>
                <setMetadataValue fieldName="invitation_id" dataLogFormat="&lt;userId&gt;"/>
                <gotoPresenter target="InvitationValidationExample"/>
            </onSuccess>
        </switchUserIdButton>
        <addPadding/>
        <targetButton featureText="Edit Invitation" target="EnterInvitationMetadata"/>
        <addPadding/>
        <actionButton featureText="Validate Invitation">
            <transmitResults matchingRegex="invitation_id|session_id|session_copepods|session_copepod|session_next_copepod" enabledRegex="validated_invitation_id|copepod_done|validation_error|session_validation_error|session_copepods|session_copepod|session_next_copepod" dataLogFormat="Is this Invitation ID for this session copepod valid? Please respond with a 200 if it is and provide either validated_invitation_id or a variable validation_error if you want a human readable message to be shown. Otherwise a non 200 / error code will just prevent the user proceeding.">
                <onError>
                    <addPadding/>
                    <htmlText featureText="Transmitting the data for this session copepod failed. Please check your experiment registrationUrl (registrationUrlStaging and registrationUrlProduction) in your listing.json (built in validation is set by default)"/>
                </onError>
                <onSuccess>
                    <addPadding/>
                    <htmlText featureText="Transmitting the data for this session copepod ok"/>
                    <hasMetadataValue fieldName="session_validation_error" matchingRegex=".+">
                        <conditionTrue>
                            <addPadding/>
                            <htmlTokenText featureText="&lt;metadataField_session_validation_error&gt;"/>                                                                                
                        </conditionTrue>
                        <conditionFalse>                            
                        </conditionFalse>
                    </hasMetadataValue>
                    <hasMetadataValue fieldName="validation_error" matchingRegex=".+">
                        <conditionTrue>
                            <addPadding/>
                            <htmlTokenText featureText="&lt;metadataField_validation_error&gt;"/>                                                                                
                        </conditionTrue>
                        <conditionFalse>
                            <addPadding/>
                        </conditionFalse>
                    </hasMetadataValue>
                    <hasMetadataValue fieldName="invitation_id" matchingRegex="&lt;metadataField_validated_invitation_id&gt;">
                        <conditionTrue>
                            <addPadding/>
                            <htmlText featureText="The the return value validated_invitation_id from transmitResults matches the provided invitation_id and the participant can proceed."/>
                            <addPadding/>
                            <htmlTokenText featureText="You can now try editing the metadata for combinations that will prevent validation, such as copepod_done = yes."/>
                            <!--<targetButton featureText="volgende [ spatiebalk ]" hotKey="SPACE" target="InvitationCodeExampleStimuliScreen"/>-->
                        </conditionTrue>
                        <conditionFalse>
                            <addPadding/>
                            <htmlText featureText="The the return value validated_invitation_id from transmitResults does NOT match the provided invitation_id and the current user ID."/>
                        </conditionFalse>
                    </hasMetadataValue>
                </onSuccess>
            </transmitResults>
        </actionButton>
        <!--<htmlText featureText="Valid get parameters for this screen for example: &quot;?invitation_id=98dfc59e-f4bf-46c1-8b62-48f12ebe7c29&amp;session_id=6&amp;session_copepods=audiosimplereactiontime_lilbq4_audioas2_peabodyas_audiononwordmonitoring_grammaras_visualsimplereactiontime#InvitationSessionStepsExample&quot;.&lt;br/&gt;You can append these GET parameters to the URL and reload this page."/>-->
    </presenter>
    <stimuli>
        <stimulus code="NC1" identifier="322" correctResponses="ugly" ratingLabels="bad,good,ugly,cat,meow" label="Bij de auditie waren. 1" pauseMs="0" tags="RatingToggle"/>
    </stimuli>
</experiment>