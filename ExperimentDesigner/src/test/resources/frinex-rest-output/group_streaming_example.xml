<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<experiment xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="http://frinexbuild.mpi.nl/alpha.xsd"
            appNameDisplay="group_streaming_example" 
            appNameInternal="group_streaming_example" 
            backgroundColour="#FFFFFF" 
            complementColour0="#EAC3A3" 
            complementColour1="#9D7B5E" 
            complementColour2="#C69E7C" 
            complementColour3="#FFEDDE" 
            complementColour4="#FFFDFB" 
            defaultScale="1.0" 
            isScalable="true" 
            preserveLastState="false" 
            primaryColour0="#628D8D" 
            primaryColour1="#385E5E" 
            primaryColour2="#4A7777" 
            primaryColour3="#96ADAD" 
            primaryColour4="#D5D8D8" 
            rotatable="true" 
            showMenuBar="false"
            obfuscateBrowserStorage="false"
            textFontSize="17">
        <deployment 
            publishDate="2020-02-02" 
            expiryDate="2021-05-22"
            isWebApp="true"
            isDesktop="false" 
            isiOS="false"
            isAndroid="false"
            state="draft"
            frinexVersion="alpha"
            stunServer="stun.example.com"
        /> 
    <administration />
    <metadata>
        <field controlledMessage="stimulusImageRegion" controlledRegex=".'{'3,'}'" postName="stimulusImageRegion" registrationField="stimulusImageRegion" />
        <field controlledMessage="distractorImageRegion" controlledRegex=".'{'3,'}'" postName="distractorImageRegion" registrationField="distractorImageRegion" />
    </metadata>
    <presenter back="Menu" menuLabel="Instruction" type="text" self="Instruction" title="Instruction">
        <htmlText featureText="This example demonstrates the streaming audio, video and shared canvas in Frinex group experiments. Group experiments are run with multiple participants, each on different computers over the network. As a result to use this example in the normal configuration you will need to run this experiment on multiple computers simultaneously." />
        <targetButton featureText="volgende [ spatiebalk ]" hotKey="SPACE" target="GroupStreamingExample" />
        <addPadding />
        <htmlText featureText="In order to make testing a group experiment easier there is a group test page which emulates multiple browsers by using iframes and javascript to predefine a random but shared group and assign group member codes via the URL of each of the experiment instances. This allows up to eight experiment instances (group members) to run simultaneously in one browser window. This group emulation page also contains a robot, that when enabled, randomly presses buttons on each instance causing the experiment to proceed without intervention." />
        <htmlText featureText="You can see some basic streaming interaction with the &lt;a href=&quot;webrtctestframes.html&quot;&gt;robot group streaming test page&lt;/a&gt;.&lt;br/&gt;" />
        <htmlText featureText="You can see an automated group interaction with the &lt;a href=&quot;grouptestframes.html&quot;&gt;robot group test page&lt;/a&gt;.&lt;br/&gt;" />
        <addPadding />
        <htmlText featureText="The group experiments function by the use of a group communication server. The messages from each group member are sent to the group server and then broadcast to all group members. Not all group messages are to be used by all group members. For example if two members are not in the same communication channel, they will not respond to each others messages." />
        <htmlText featureText="You can observe the underlying group messaging functionality in your browser with the &lt;a href=&quot;webrtctestpage.html&quot;&gt;group diagnostics page&lt;/a&gt;.&lt;br/&gt;" />
    </presenter>
    <presenter back="Instruction" menuLabel="GroupStreamingExample" next="Menu" type="stimulus" self="GroupStreamingExample" title="GroupStreamingExample">
        <!--regionReplace regionId="groupButtonsRegion"/-->
        <addPadding />
        <regionAppend regionId="groupStatus" />
        <addPadding />
        <regionAppend regionId="groupOutput" />
        <addPadding />
        <regionAppend regionId="groupIntroduction"> 
            <hasGetParameter parameterName="group">
                <conditionTrue>
                    <htmlText featureText="The group name has been allocated in the URL. This member will be placed in the group associated with this name provided the member code is not already taken." />
                    <addPadding />
                </conditionTrue>
                <conditionFalse>
                    <htmlText featureText="The group name has not been provided in the URL and a group will be randomly assigned. A specific group can be assigned by appending &amp;group=X to the URL." />
                    <addPadding />
                </conditionFalse>
            </hasGetParameter>
            <hasGetParameter parameterName="member">
                <conditionTrue>
                    <htmlText featureText="The group member code has been provided in the URL. This participant will be added to a group where the supplied member code is not already taken." />
                    <addPadding />
                </conditionTrue>
                <conditionFalse>
                    <htmlText featureText="The group member code has not been provided. This member will not be assigned a group without a member code being provided in the URL." />
                    <htmlText featureText="You can specify the member code by adding &amp;member=X to the URL." />
                    <addPadding />
                </conditionFalse>
            </hasGetParameter>    
        </regionAppend>
        <addPadding />
        <table>
            <row>
                <column>
                    <regionReplace regionId="groupRemoteCanvas_A_Region" />
                </column>
                <column>
                    <regionReplace regionId="groupRemoteCanvas_B_Region" />
                </column>
                <column>
                    <regionReplace regionId="groupRemoteCanvas_C_Region" />
                </column>
            </row><row>
                <column>
                    <regionReplace regionId="groupRemoteCamera_A_Region" />
                </column>
                <column>
                    <regionReplace regionId="groupRemoteCamera_B_Region" />
                </column>
                <column>
                    <regionReplace regionId="groupRemoteCamera_C_Region" />
                </column>
            </row>
        </table>
        <triggerDefinition listenerId="terminateStreams" threshold="0" maximum="0">
            <!-- stop existing streams by clearing their regions -->
            <regionReplace regionId="groupRemoteCanvas_A_Region" />
            <regionReplace regionId="groupRemoteCanvas_B_Region" />
            <regionReplace regionId="groupRemoteCanvas_C_Region" />
            <regionReplace regionId="groupRemoteCamera_A_Region" />
            <regionReplace regionId="groupRemoteCamera_B_Region" />
            <regionReplace regionId="groupRemoteCamera_C_Region" />
            <!-- clear the text -->
            <regionReplace regionId="groupIntroduction" />
            <regionReplace regionId="groupStatus" />
            <regionReplace regionId="groupOutput" />
        </triggerDefinition>
        <groupStimuli adjacencyThreshold="0" eventTag="GroupStreamingExample" randomise="false" repeatRandomWindow="0" maxStimuli="100" repeatCount="1">
            <groupNetwork groupMembers="A,B,C" phasesPerStimulus="24" groupCommunicationChannels="A,B,C">
                <groupInitialisationError>
                    <regionReplace regionId="groupStatus">
                        <htmlText featureText="groupInitialisationError please make sure the group and member code are provided in the URL" />
                    </regionReplace>
                    <regionReplace regionId="groupOutput"></regionReplace>
                </groupInitialisationError>
                <groupNetworkConnecting>
                    <regionReplace regionId="groupStatus">
                        <htmlText featureText="groupNetworkConnecting" />
                    </regionReplace>
                    <regionReplace regionId="groupOutput"></regionReplace>
                </groupNetworkConnecting>
                <groupFindingMembers>
                    <regionReplace regionId="groupStatus">
                        <htmlText featureText="groupFindingMembers: waiting for the required members for this channel" />
                    </regionReplace>
                    <regionReplace regionId="groupOutput">
                        <htmlTokenText featureText="This is member: ::groupMemberCode::" />
                        <htmlTokenText featureText="Required members: ::groupAllMemberCodes::" />
                        <htmlTokenText featureText="Assigned members: ::groupAssignedMemberCodes::" />
                        <htmlTokenText featureText="Group: ::groupId::" />
                        <htmlTokenText featureText="Group UUID: ::groupUUID::" />
                        <addPadding />
                    </regionReplace>
                </groupFindingMembers>
                <groupNetworkSynchronising>
                    <regionReplace regionId="groupStatus">
                        <htmlText featureText="GroupStreamingExample groupNetworkSynchronising" />
                    </regionReplace>
                    <regionReplace regionId="groupOutput">
                        <htmlTokenText featureText="Stimulus: ::stimulusId:: Phase: ::groupRequestedPhase:: Channel: ::groupActiveChannel::" />                    
                    </regionReplace>
                </groupNetworkSynchronising>
                <groupPhaseListeners>
                    <groupMemberActivity phaseMembers="A:B:C:A:B:C:A:B:C:A:B:C:A:B:C:A:B:C:A:B:C:A:B:C">
                        <regionReplace regionId="groupOutput">
                            <actionButton featureText="Stream is OK" groupId="responseButtonGroup">
                                <setStimulusCodeResponse codeFormat="Stream is OK ::groupMemberCode:: ::groupRequestedPhase::" dataChannel="8" applyScore="true"/>
                                <sendGroupMessage eventTag="Stream is OK" incrementPhase="1" />
                            </actionButton>
                            <addPadding />
                            <actionButton featureText="Stream is broken" groupId="responseButtonGroup">
                                <setStimulusCodeResponse codeFormat="Stream is broken ::groupMemberCode:: ::groupRequestedPhase::" dataChannel="8" applyScore="true"/>
                                <sendGroupMessage eventTag="Stream is broken" incrementPhase="1" />
                            </actionButton>
                        </regionReplace>
                    </groupMemberActivity>
                    <groupMemberActivity phaseMembers="BC:CA:AB:BC:CA:AB:BC:CA:AB:BC:CA:AB:BC:CA:AB:BC:CA:AB:BC:CA:AB:BC:CA:AB">
                        <regionReplace regionId="groupOutput">
                            <htmlText featureText="Please wait for the other members of the group to perform their tasks." />
                        </regionReplace>
                    </groupMemberActivity>
                    <!-- ab video|bc video| ca video|ab canvas|bc canvas|ca canvas|abc video|abc canvas -->
                    <groupMemberActivity phaseMembers="C:-:A:-:B:-:C:-:A:-:B:-:-:-:-:-:-:-:-:-:-:-:-:-">
                        <triggerMatching listenerId="terminateStreams"/>
                    </groupMemberActivity>
                    <groupMemberActivity phaseMembers="A,B:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-">
                        <triggerMatching listenerId="terminateStreams"/>
                        <streamGroupCanvas streamChannels="A,B">
                            <onSuccess>
                                <plainText featureText="streamGroupCanvas onSuccess A,B"/>
                            </onSuccess>
                            <onError>
                                <plainText featureText="streamGroupCanvas onError A,B"/>
                            </onError>
                        </streamGroupCanvas>
                    </groupMemberActivity>
                    <groupMemberActivity phaseMembers="-:-:B,C:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-">
                        <triggerMatching listenerId="terminateStreams"/>
                        <streamGroupCanvas streamChannels="B,C">
                            <onSuccess>
                                <plainText featureText="streamGroupCanvas onSuccess B,C"/>
                            </onSuccess>
                            <onError>
                                <plainText featureText="streamGroupCanvas onError B,C"/>
                            </onError>
                        </streamGroupCanvas>
                    </groupMemberActivity>
                    <groupMemberActivity phaseMembers="-:-:-:-:C,A:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-:-">
                        <triggerMatching listenerId="terminateStreams"/>
                        <streamGroupCanvas streamChannels="C,A">
                            <onSuccess>
                                <plainText featureText="streamGroupCanvas onSuccess C,A"/>
                            </onSuccess>
                            <onError>
                                <plainText featureText="streamGroupCanvas onError C,A"/>
                            </onError>
                        </streamGroupCanvas>
                    </groupMemberActivity>
                </groupPhaseListeners>
            </groupNetwork>
            <endOfStimulus>
                <clearPage/>
                <actionButton featureText="resetStimulus">
                    <resetStimulus target="GroupStreamingExample"/>
                    <gotoPresenter target="GroupStreamingExample"/>
                </actionButton>
            </endOfStimulus>
            <randomGrouping />
            <stimuli>
                <tag>BalloonGroup</tag>
            </stimuli> 
        </groupStimuli>
    </presenter>
    <presenter back="Menu" menuLabel="GroupStreamingTester" type="stimulus" self="GroupStreamingTester" title="Streaming">
        <regionAppend regionId="groupIntroduction">
            <htmlText featureText="This example has a group of three with two communication channels. A and B share a communication channel and B and C also share a communication channel. This means that B communicates with both A and C. But A and C never communicate directly." />
        </regionAppend>
        <addPadding />
        <regionAppend regionId="groupStatus" />
        <addPadding />
        <regionAppend regionId="groupOutput" />
        <addPadding />
        <regionAppend regionId="groupButtons" />
        <addPadding />
        <groupStimuli adjacencyThreshold="0" eventTag="GroupStreamingTester" randomise="false" repeatRandomWindow="0" maxStimuli="100" repeatCount="1">
            <groupNetwork groupMembers="A,B,C" phasesPerStimulus="3" groupCommunicationChannels="A,B|B,C">
                <groupInitialisationError>
                    <regionReplace regionId="groupIntroduction" />
                    <regionReplace regionId="groupStatus">
                        <htmlText featureText="groupInitialisationError please make sure the group and member code are provided in the URL" />
                    </regionReplace>
                    <regionReplace regionId="groupOutput"></regionReplace>
                </groupInitialisationError>
                <groupNetworkConnecting>
                    <regionReplace regionId="groupStatus">
                        <htmlText featureText="GroupStreamingTester groupNetworkConnecting" />
                    </regionReplace>
                    <regionReplace regionId="groupOutput">
                        <htmlTokenText featureText="Stimulus: ::stimulusId:: Phase: ::groupRequestedPhase:: Channel: ::groupActiveChannel::" />
                    </regionReplace>
                </groupNetworkConnecting>
                <groupFindingMembers>
                    <regionReplace regionId="groupStatus">
                        <htmlText featureText="groupFindingMembers: waiting for the required members for this channel" />
                    </regionReplace>
                    <regionReplace regionId="groupOutput">
                        <htmlTokenText featureText="This is member: ::groupMemberCode::" />
                        <htmlTokenText featureText="Required members: ::groupAllMemberCodes::" />
                        <htmlTokenText featureText="Assigned members: ::groupAssignedMemberCodes::" />
                        <htmlTokenText featureText="Group: ::groupId::" />
                        <htmlTokenText featureText="Group UUID: ::groupUUID::" />
                        <addPadding />
                    </regionReplace>
                </groupFindingMembers>
                <groupNetworkSynchronising>
                    <regionReplace regionId="groupStatus">
                        <htmlText featureText="groupNetworkSynchronising" />
                    </regionReplace>
                    <regionReplace regionId="groupOutput">
                        <htmlTokenText featureText="Stimulus: ::stimulusId:: Phase: ::groupRequestedPhase:: Channel: ::groupActiveChannel::" />                    
                        <htmlTokenText featureText="Connected to: ::groupId::&lt;br/&gt;&lt;br/&gt;Group members: ::groupAllMemberCodes::&lt;br/&gt;&lt;br/&gt;As member: ::groupMemberCode::&lt;br/&gt;&lt;br/&gt;" />
                    </regionReplace>
                </groupNetworkSynchronising>
                <groupPhaseListeners>
                    <!-- <groupMemberActivity phaseMembers="B,C:A,C:A,B">
                        <regionReplace regionId="groupIntroduction" />
                        <regionReplace regionId="groupStatus">
                            <htmlTokenText featureText="B,C:A,C:A,B" />
                            <htmlTokenText featureText="::groupMemberCode:: is waiting" />
                        </regionReplace>
                        <regionReplace regionId="groupOutput"></regionReplace>
                        <regionReplace regionId="groupButtonsRegion"></regionReplace>
                    </groupMemberActivity> -->
                    <groupMemberActivity phaseMembers="ABC:-:-">
                        <regionReplace regionId="groupIntroduction" />
                        <regionReplace regionId="groupStatus">
                            <htmlTokenText featureText="ABC:-:-" />
                        </regionReplace>
                        <regionReplace regionId="groupOutput">
                            <htmlTokenText featureText="Stimulus: ::stimulusId:: Phase: ::groupRequestedPhase:: Channel: ::groupActiveChannel::" />
                            <htmlTokenText featureText="groupActiveChannel: ::groupActiveChannel::" />
                            <htmlTokenText featureText="groupMemberCode: ::groupMemberCode::" />
                        </regionReplace>
                        <regionReplace regionId="groupButtonsRegion">
                            <stimulusLabel />
                            <actionButton featureText="sendGroupStoredMessage">
                                <sendGroupStoredMessage incrementPhase="1" groupId="MessageType1" />
                            </actionButton>
                            <actionButton featureText="start streamGroupCanvas">
                                <streamGroupCanvas streamChannels="A,B|B,C">
                                    <onSuccess>
                                        <plainText featureText="streamGroupCanvas onSuccess A,B|B,C"/>
                                    </onSuccess>
                                    <onError>
                                        <plainText featureText="streamGroupCanvas onError A,B|B,C"/>
                                    </onError>
                                </streamGroupCanvas>
                            </actionButton>
                            <actionButton featureText="start streamGroupCamera">
                                <streamGroupCamera streamChannels="A,B|B,C">
                                    <onSuccess>
                                        <plainText featureText="streamGroupCamera onSuccess A,B|B,C"/>
                                    </onSuccess>
                                    <onError>
                                        <plainText featureText="streamGroupCamera onErrorA,B|B,C"/>
                                    </onError>
                                </streamGroupCamera>
                            </actionButton>
                            <actionButton featureText="clear local canvas stream region">
                                <regionReplace regionId="groupLocalCanvasRegion" />
                            </actionButton>
                            <actionButton featureText="clear local video stream region">
                                <regionReplace regionId="groupLocalVideoRegion" />
                            </actionButton>
                            <actionButton featureText="clear remote receive stream region">
                                <!-- <regionReplace regionId="groupRemoteStream_A_Region" />
                                <regionReplace regionId="groupRemoteStream_B_Region" />
                                <regionReplace regionId="groupRemoteStream_C_Region" /> -->
                                <regionReplace regionId="groupRemoteCanvas_A_Region" />
                                <regionReplace regionId="groupRemoteCanvas_B_Region" />
                                <regionReplace regionId="groupRemoteCanvas_C_Region" />
                                <regionReplace regionId="groupRemoteCamera_A_Region" />
                                <regionReplace regionId="groupRemoteCamera_B_Region" />
                                <regionReplace regionId="groupRemoteCamera_C_Region" />
                            </actionButton>
                        </regionReplace>
                    </groupMemberActivity>
                    <groupMemberActivity phaseMembers="-:B:-">
                        <regionReplace regionId="groupIntroduction" />
                        <regionReplace regionId="groupStatus">
                            <htmlTokenText featureText="-:B:-" />
                        </regionReplace>
                        <regionReplace regionId="groupOutput">
                            <htmlTokenText featureText="Stimulus: ::stimulusId:: Phase: ::groupRequestedPhase:: Channel: ::groupActiveChannel::" />
                            <htmlTokenText featureText="groupActiveChannel: ::groupActiveChannel::" />
                            <htmlTokenText featureText="groupMemberCode: ::groupMemberCode::" />
                        </regionReplace>
                        <regionReplace regionId="groupButtonsRegion">
                            <sendGroupMessageButton repeatIncorrect="false" incrementPhase="1" featureText="forward message" />
                        </regionReplace>
                    </groupMemberActivity>
                    <groupMemberActivity phaseMembers="-:-:C">
                        <regionReplace regionId="groupIntroduction" />
                        <regionReplace regionId="groupStatus">
                            <htmlTokenText featureText="-:-:C" />
                        </regionReplace>
                        <regionReplace regionId="groupOutput">
                            <htmlTokenText featureText="Stimulus: ::stimulusId:: Phase: ::groupRequestedPhase:: Channel: ::groupActiveChannel::" />
                            <htmlTokenText featureText="groupActiveChannel: ::groupActiveChannel::" />
                            <htmlTokenText featureText="groupMemberCode: ::groupMemberCode::" />
                        </regionReplace>
                        <regionReplace regionId="groupButtonsRegion">
                            <sendGroupMessageButton repeatIncorrect="false" incrementPhase="1" featureText="forward message" />
                        </regionReplace>
                    </groupMemberActivity>
                    <groupMemberActivity phaseMembers="D,E,F,G,H:D,E,F,G,H:D,E,F,G,H">
                        <regionReplace regionId="groupIntroduction" />
                        <regionReplace regionId="groupStatus">
                            <htmlTokenText featureText="This member is not active in this activity" />
                        </regionReplace>
                        <regionReplace regionId="groupOutput">
                        </regionReplace>
                        <regionReplace regionId="groupButtonsRegion">
                        </regionReplace>
                    </groupMemberActivity>
                </groupPhaseListeners>
            </groupNetwork>
            <endOfStimulus>
                <clearPage />
                <centrePage />
                <htmlText featureText="No valid stimuli" />
            </endOfStimulus>
            <randomGrouping />
            <stimuli>
                <tag>BalloonGroup</tag>
            </stimuli>
        </groupStimuli>
    </presenter>
    <presenter menuLabel="Menu" type="menu" self="Menu" title="Menu">
        <allMenuItems />
    </presenter>
    <stimuli>
        <stimulus correctResponses="OK" code="stimulus1" identifier="stimulus1" label="Stimulus 1" pauseMs="0" tags="BalloonGroup" />
        <stimulus correctResponses="OK" code="stimulus2" identifier="stimulus2" label="Stimulus 2" pauseMs="0" tags="BalloonGroup" />
        <stimulus correctResponses="OK" code="stimulus3" identifier="stimulus3" label="Stimulus 3" pauseMs="0" tags="BalloonGroup" />
        <stimulus correctResponses="OK" code="1" identifier="Image1" imagePath="1_A.png" label="1" tags="GroupOf2Images" />
        <stimulus correctResponses="OK" code="2" identifier="Image2" imagePath="2_A.png" label="2" tags="GroupOf2Images" />
        <stimulus correctResponses="OK" code="3" identifier="Image3" imagePath="3_A.png" label="3" tags="GroupOf2Images" />
        <stimulus correctResponses="OK" code="4" identifier="Image4" imagePath="4_A.png" label="4" tags="GroupOf2Images" />
        <stimulus correctResponses="OK" code="5" identifier="Image5" imagePath="5_A.png" label="5" tags="GroupOf2Images" />
        <stimulus correctResponses="OK" code="6" identifier="Image6" imagePath="6_A.png" label="6" tags="GroupOf2Images" />
    </stimuli> 
</experiment>
