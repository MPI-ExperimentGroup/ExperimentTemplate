<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<experiment xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:noNamespaceSchemaLocation="http://frinexbuild.mpi.nl/beta.xsd"
    appNameDisplay="Timer Averaging Example">
    <deployment state="staging" />
    <metadata>
        <field controlledMessage="." controlledRegex="0-9*" postName="samplesCount" registrationField="SampleCount" />
        <field controlledMessage="." controlledRegex="0-9*" postName="samplesSum" registrationField="SampleSum" />
        <field controlledMessage="." controlledRegex="0-9*" postName="samplesAverage" registrationField="SampleAverage" />
    </metadata>
    <presenter type="stimulus">
        <triggerDefinition listenerId="startAveragingTimer" threshold="0" maximum="1000">
            <clearTimer listenerId="averagingTimer" />
            <hardwareTimeStamp opto1="true" opto2="true"/>
            <addTimerTrigger minimum="100" maximum="100" evaluateTokens="100" listenerId="averagingTimer">
                <onTimer><hardwareTimeStamp opto1="false"/></onTimer>
                <onError><hardwareTimeStamp  opto1="false"/></onError>
            </addTimerTrigger>
            <addTimerTrigger minimum="600" maximum="600" evaluateTokens="600" listenerId="averagingTimer">
                <onTimer><triggerMatching listenerId="startAveragingTimer"/></onTimer>
                <onError><triggerMatching listenerId="startAveragingTimer"/></onError>
            </addTimerTrigger>
            <startTimer msToNext="500" listenerId="averagingTimer">
                <hardwareTimeStamp opto2="false"/>
                <htmlTokenText featureText="averagingTimer: ::averagingTimer::"></htmlTokenText>
                <setMetadataEvalTokens fieldName="samplesSum" evaluateTokens="::metadataField_samplesSum::+::averagingTimer::">
                    <onSuccess>
                        <htmlTokenText featureText="Sum: ::metadataField_samplesSum::" />
                    </onSuccess>
                    <onError>
                        <htmlText featureText="Sum: Error" />
                    </onError>
                </setMetadataEvalTokens>
                <setMetadataEvalTokens fieldName="samplesCount" evaluateTokens="::metadataField_samplesCount::+1">
                    <onSuccess>
                        <htmlTokenText featureText="Count: ::metadataField_samplesCount::" />
                    </onSuccess>
                    <onError>
                        <htmlText featureText="Count: Error" />
                    </onError>
                </setMetadataEvalTokens>
                <setMetadataEvalTokens fieldName="samplesAverage" evaluateTokens="::metadataField_samplesSum::/::metadataField_samplesCount::">
                    <onSuccess>
                        <htmlTokenText featureText="Average: ::metadataField_samplesAverage::" />
                    </onSuccess>
                    <onError>
                        <htmlText featureText="Averaging: Error" />
                    </onError>
                </setMetadataEvalTokens>
            </startTimer>
        </triggerDefinition>
        <htmlText featureText="&lt;a href=&quot;?hardwareTimeStamp&quot;&gt;Enable HardwareTimeStamps&lt;/a&gt;"/>
        <actionButton featureText="Start Timer (500ms 1000 times)" groupId="startButton">
            <disableButtonGroup matchingRegex="startButton" />
            <setMetadataValue fieldName="samplesSum" dataLogFormat="0" />
            <setMetadataValue fieldName="samplesCount" dataLogFormat="0" />
            <setMetadataValue fieldName="samplesAverage" dataLogFormat="0" />
            <triggerMatching listenerId="startAveragingTimer"/>
        </actionButton>
    </presenter>
    <stimuli />
</experiment>